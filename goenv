#  -*- mode: unix-shell-script; -*-

_goenv_help() {
    echo "Go workspace manager"
    echo
    echo "Usage:"
    echo "    goenv command [arguments]"
    echo
    echo "The commands are:"
    echo "    run        detects go path and runs command in that environment"
    echo "    init       initialize path as workspace (default working directory)"
    echo "    switch     switch workspace to path (default to working directory)"
    echo "    add        add path to workspace (default working directory)"
    echo "    rm         remove path from workspace (default working directory)"
    echo "    reset      reset to empty workspace"
    echo "    list       list all workspace paths"
    echo "    which      show current Go workspace"
    echo "    env        environment variables for workspace"
    echo "    edit       open package path in VISUAL editor (default \$GOPATH/src)"
    echo "    cd         switch to directory of package path (default \$GOPATH/src)"
    echo
    echo "goenv manages the workspace by setting the GOPATH environment variable"
    echo "When setting or adding a workspace, goenv will search up the path"
    echo "to find the parent with the required GOPATH entries of bin, pkg, and src"
}

_goenv_commands() {
	for c in run init switch add rm reset list which env edit cd; do
		echo $c
	done
}

_goenv_complete() {
	case "$1" in
		cd | edit)
			# Use current workspace only
			(
				# go list std doesn't include cmd/internal/rsc.io/* so filter manually
				GOPATH=`_goenv_find_ws_path`
				comm -3 <(go list all) <(go list std) | grep -v "cmd/internal/*"
			)
			;;
		*)
			;;
	esac
}

_goenv_fullpath() {
  case "$1" in
    /*)
        echo "$1"
        ;;
    *)
        echo "$PWD/$1"
        ;;
  esac
}

_goenv_find_ws_path() {
    local WSPATH=$(pwd)
    while [[ "$WSPATH" != "" && ! -e "$WSPATH/bin" && ! -e "$WSPATH/pkg" && ! -e "$WSPATH/src" ]]; do
        WSPATH=${WSPATH%/*}
    done
    echo "$WSPATH"
}

_goenv_split() {
    OLDIFS="$IFS"
    IFS=$2
    items=(`echo $1`)
    IFS="$OLDIFS"
    echo $items
}

_goenv_init() {
    if [ -n "$1" ]; then
        mkdir -p $1/bin
        mkdir -p $1/pkg
        mkdir -p $1/src
        _goenv_add $1
    else
        echo "Path does not exist"
    fi
}

_goenv_switch() {
	# Reset workspace if already set
	if [ -n "$_GOENV_OLD_PATH" ]; then
		_goenv_reset
	fi
	
	# Cache original values before switching to allow reset
    if [[ -n "$1" && -d "$1" ]]; then
        _GOENV_OLD_PATH=$PATH
        export _GOENV_OLD_PATH
        
        if [ -n "$GOPATH" ]; then    
			_GOENV_OLD_GOPATH=$GOPATH
			export _GOENV_OLD_GOPATH
        fi

        GOPATH=$GOPATH:$1
        export GOPATH
        
        PATH=$PATH:$GOPATH/bin
        export PATH
    else
        echo "Go workspace missing"
    fi
}

_goenv_add() {
    if [[ -n "$1" && -d "$1" ]]; then
        if [[ -n "$GOPATH" && "$GOPATH" =~  (^|:)"$1"(:|$) ]]; then
            echo "Workspace already added"
        elif [ -z "$_GOENV_OLD_PATH" ]; then
            _goenv_switch $1
        else
            GOPATH=$GOPATH:$1
            export GOPATH
            
            PATH=$_GOENV_OLD_PATH:${GOPATH//://bin:}/bin
            export PATH
        fi
    else
        echo "Go workspace missing"
    fi
}

_goenv_rm() {
    if [[ -n "$1" && -d "$1" && -n "$GOPATH" && "$GOPATH" =~  (^|:)"$1"(:|$) ]]; then
        local items=$GOPATH
        _goenv_reset $@
        items=(`_goenv_split $items ":"`)
        for item in "${items[@]}"; do
            if [ "$item" != "$1" ]; then
                _goenv_add $item
            fi
        done
    else
        echo "Go workspace missing"
    fi
}

_goenv_reset() {
    if [ -n "$GOPATH" ]; then
        if [ -n "$_GOENV_OLD_PATH" ]; then
            PATH=$_GOENV_OLD_PATH
            export PATH
            unset _GOENV_OLD_PATH
        fi
        if [ -n "$_GOENV_OLD_GOPATH" ]; then
        	GOPATH=$_GOENV_OLD_GOPATH
        	export GOPATH
	        unset _GOENV_OLD_GOPATH
	    fi
    else
        echo "Go workspace not set"
    fi
}

_goenv_list() {    
    if [[ -n "$GOPATH" ]]; then
        items=(`_goenv_split $GOPATH ":"`)
        for item in "${items[@]}"; do
          echo "$item"
        done
    else
        echo "Go workspace not set"
    fi
}

_goenv_which() {
    echo `_goenv_find_ws_path`
}

_goenv_env() {
        echo "GOPATH=$GOPATH"
        echo "GOROOT=$GOROOT"        
}

_goenv_edit() {
    if [[ -n "$GOPATH" ]]; then
		if [ -z "$VISUAL" ]; then
			echo "VISUAL editor is not set"
			exit 1
		fi
		"$VISUAL" "`_goenv_find_ws_path`/src/$1"
	else
		echo "Go workspace not set"
	fi
}

_goenv_cd() {
	cd `_goenv_find_ws_path`/src/$1
	_goenv_add `_goenv_find_ws_path`
}

_goenv_exec() {
    case "$1" in
    init)
        if [ -z "$2" ]; then
            _goenv_init $(pwd)
        else
            _goenv_init `_goenv_fullpath $2`
        fi
        ;;
    switch)
        if [ -z "$2" ]; then
            _goenv_switch `_goenv_find_ws_path`
        else
            _goenv_switch `_goenv_fullpath $2`
        fi
        ;;
    add)
        if [ -z "$2" ]; then
            _goenv_add `_goenv_find_ws_path`
        else
            _goenv_add `_goenv_fullpath $2`
        fi
        ;;
    rm)
        if [ -z "$2" ]; then
            _goenv_rm `_goenv_find_ws_path`
        else
            _goenv_rm `_goenv_fullpath $2`
        fi
        ;;
    edit)
        _goenv_edit $2
        ;;
    cd)
    	_goenv_cd $2
    	;;
    *)
        echo "Invalid command"
    esac
}

goenv() {
    cmd=$1
    
    case "$cmd" in
    cd | edit | switch)
    	_goenv_exec $@
        ;;
	# Can add/remove/init a list of directories
    add | rm | init)
    	shift
    	if [ $# -gt 0 ]; then
    		while (($#)); do
    			_goenv_exec $cmd $1
    			shift
    		done
    	else
    		_goenv_exec $@
    	fi
    	;;
    run)
    	shift
    	(
    		_goenv_exec "switch"
    		if [ 0 -eq $? ]; then
    			$@
    		fi
    	)
    	;;
    reset     ) _goenv_reset $@;;
    list      ) _goenv_list $@;;
    which     ) _goenv_which $@;;
    env       ) _goenv_env $@;;
    --commands) _goenv_commands $@;;
    --complete)
    	shift
    	if [ $# -gt 0 ]; then
    		_goenv_complete $*
    	fi
    	;;
    help | *) _goenv_help;;
    esac
}

# Setup completion
if [ -n "$BASH_VERSION" ]; then
	source "$(dirname "${BASH_SOURCE[0]}")/goenv.bash"
elif [ -n "$ZSH_VERSION" ]; then
	source "$(dirname "$0")/goenv.zsh"
fi
